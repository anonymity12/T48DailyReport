# 2018-08-14

today I read most APUR3rd C 16 about socket in user space, aka `ruptime.c` but not about netlink

conclusion of `ruptime.c` :

所以整个程序的执行过程是：将服务器进程初始化为一个守护进程，程序名为ruptimed，这个程序提供ruptime服务（即调用uptime函数），调用getaddrinfo时，进程去主机host查找“ruptime”在/etc/services对应的端口号，经过hint过滤addrinfo的链表中，选取一个地址，将其和一个套接字绑定，然后监听，以便服务器和客户端建立链接。客户端调用getaddrinfo函数查找服务器上的ruptime服务，建立链接。

## todo

- [x] (not urge)read makefile doc and solve pics problem in T48/img
- [ ] netlink by https://blog.csdn.net/u012819339/article/details/51334600

## looking for `connect_retry()`

when socket/ruptime.c compiling , no extern declaration of  `connect_retry()` found ,so when u want socket/ruptime.c to compile well, u need other folder's support, u can see in socket/makefile as follow, we got `LIBAPUE`, which is come from `Make.libapue.inc`

```
# Make.libapue.inc
$(LIBAPUE):
    (cd $(ROOT)/lib && $(MAKE))
## so this told us: go to /lib and see libapue.a
```


```
# socket/makefile
ROOT=..
PLATFORM=$(shell $(ROOT)/systype.sh)
include $(ROOT)/Make.defines.$(PLATFORM)

ifeq "$(PLATFORM)" "solaris"
  EXTRALIBS = -lsocket -lnsl
endif

PROGS = ruptime ruptimed ruptimed-fd ruptimed-dg
MOREPROGS = findsvc ruptime-dg

all:    $(PROGS) $(MOREPROGS) clconn.o clconn2.o initsrv1.o initsrv2.o 

%:  %.c $(LIBAPUE)

ruptime:    ruptime.o clconn2.o $(LIBAPUE)
        $(CC) $(CFLAGS) -o ruptime ruptime.o clconn2.o $(LDFLAGS) $(LDLIBS)

ruptimed:   ruptimed.o initsrv2.o $(LIBAPUE)
        $(CC) $(CFLAGS) -o ruptimed ruptimed.o initsrv2.o $(LDFLAGS) $(LDLIBS)

ruptimed-fd:    ruptimed-fd.o initsrv2.o $(LIBAPUE)
        $(CC) $(CFLAGS) -o ruptimed-fd ruptimed-fd.o initsrv2.o $(LDFLAGS) $(LDLIBS)

ruptimed-dg:    ruptimed-dg.o initsrv2.o $(LIBAPUE)
        $(CC) $(CFLAGS) -o ruptimed-dg ruptimed-dg.o initsrv2.o $(LDFLAGS) $(LDLIBS)

clean:
    rm -f $(PROGS) $(MOREPROGS) $(TEMPFILES) *.o

include $(ROOT)/Make.libapue.inc

```


anyway, the solution is use make at most outside folder, it will recursively make all subfolder. but one error occur:(when it comes: `make[1]: Leaving directory '/home/user/Desktop/osPrincple/hand_free/fuck_apue_3e/threads'`)



![Alt text](img/makefile_fail_for_something_in_threads_folder.png "Optional title")

anyway, executable in /socket is OK. `findsrv.c` have following output:

![Alt text](img/findsrv_exec_ok.png "Optional title")


### ruptime

u may have error like `Servname not supported for ai_socktype`
, and solution is:

```　　
服务器端的程序名为ruptimed，服务名为ruptime，为客户端提供uptime服务，由于ruptime服务是用户自定义的服务，在调用getaddrinfo时出现如下错误：

1 `Servname not supported for ai_socktype`

我给getaddrinfo函数提供了主机名和服务名，但需要在系统中登记，即将ruptime和端口号写入/etc/services中（注意用户自定义的端口号不能小于1024，以免和系统已经存在的端口号冲突。程序名和服务名不必相同，服务名更像是程序的别名），将

ruptime 4000/tcp

添加到/etc/services文件末尾，这样就不会出现上面的错误。
```

## python-sphinx

to read source code in browser, 

u need

```
    sudo apt-get install graphviz dvipng librsvg2-bin virtualenv texlive-xetex virtualenv sphinx_1.4
    . sphinx_1.4/bin/activate
    pip install -r Documentation/sphinx/requirements.txt
```

`apt-get install python-sphinx`